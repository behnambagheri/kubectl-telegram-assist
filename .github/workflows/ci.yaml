name: KubectlTelegramAssist CI/CD

on:
  push:
    branches:
      - main
      - stage

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Extract Branch Name
      shell: bash
      run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
      id: extract_branch

    - name: Extract Repository Name
      id: extract_repo_name
      run: echo "repo_name=$(basename ${{ github.repository }})" >> $GITHUB_ENV

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to Docker Registry
      uses: docker/login-action@v1
      with:
        registry: reg.bea.sh
        username: agent
        password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: reg.bea.sh/${{ github.repository }}:${{ steps.extract_branch.outputs.branch }}

    - name: Format Telegram Message
      id: format_message
      run: |
        MESSAGE="ğŸš€ *CI/CD Pipeline Update* ğŸš€\n\n"
        MESSAGE+="ğŸ”¹ *Repository:* [${{ github.repository }}](https://github.com/${{ github.repository }})\n"
        MESSAGE+="ğŸ”¹ *Branch:* ${{ steps.extract_branch.outputs.branch }}\n"
        MESSAGE+="ğŸ”¹ *Commit Message:* \`${{ github.event.commits[0].message }}\`\n"
        MESSAGE+="ğŸ”¹ [See Changes](https://github.com/${{ github.repository }}/commit/${{github.sha}}) | [Action Logs](https://github.com/${{ github.repository }}/actions/runs/${{github.run_id}})"
        echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

    - name: Send Telegram Notification
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: -1001804111897
        TOPIC_ID: 21182
      run: |
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "reply_to_message_id=${TOPIC_ID}" \
          -d "parse_mode=Markdown"

    - name: Set up Kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.32.0'

    - name: Configure Kubernetes Context
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config

    - name: Rollout Restart Kubernetes Deployment
      run: kubectl rollout restart deployment/${{ env.repo_name }}-${{ steps.extract_branch.outputs.branch }}

    - name: Remove Kubeconfig for Security
      run: rm -rf $HOME/.kube

    - name: Notify on Failure
      if: failure()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: -1001804111897
        TOPIC_ID: 21182
      run: |
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=âŒ *CI/CD Pipeline Failed!* ğŸš¨\n\nğŸ”¹ *Repository:* [${{ github.repository }}](https://github.com/${{ github.repository }})\nğŸ”¹ *Branch:* ${{ steps.extract_branch.outputs.branch }}\nğŸ”¹ [See Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
          -d "reply_to_message_id=${TOPIC_ID}" \
          -d "parse_mode=Markdown"

    - name: Notify on Success
      if: success()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: -1001804111897
        TOPIC_ID: 21182
      run: |
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=âœ… *CI/CD Pipeline Success!* ğŸ‰\n\nğŸ”¹ *Repository:* [${{ github.repository }}](https://github.com/${{ github.repository }})\nğŸ”¹ *Branch:* ${{ steps.extract_branch.outputs.branch }}\nğŸ”¹ [See Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
          -d "reply_to_message_id=${TOPIC_ID}" \
          -d "parse_mode=Markdown"