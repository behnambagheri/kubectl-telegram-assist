name: KubectlTelegramAssist CI/CD

on:
  push:
    branches:
      - main
      - stage

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Extract Branch Name
      shell: bash
      run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
      id: extract_branch

    - name: Extract Repository Name
      id: extract_repo_name
      run: echo "repo_name=$(basename ${{ github.repository }})" >> $GITHUB_ENV

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to Docker Registry
      uses: docker/login-action@v1
      with:
        registry: reg.bea.sh
        username: agent
        password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: reg.bea.sh/${{ github.repository }}:${{ steps.extract_branch.outputs.branch }}

    - name: Format Telegram Message
      id: format_message
      run: |
        MESSAGE="ğŸš€ *CI/CD Pipeline Update* ğŸš€%0A"
        MESSAGE+="ğŸ“Œ *Repository:* [${{ github.repository }}](https://github.com/${{ github.repository }})%0A"
        MESSAGE+="ğŸŒ¿ *Branch:* \`${{ steps.extract_branch.outputs.branch }}\`%0A"
        MESSAGE+="ğŸ“ *Commit Message:* \`${{ github.event.commits[0].message }}\`%0A"
        MESSAGE+="ğŸ”— [ğŸ”„ See Changes](https://github.com/${{ github.repository }}/commit/${{github.sha}}) | [ğŸ“œ Action Logs](https://github.com/${{ github.repository }}/actions/runs/${{github.run_id}})"
    
        echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

    - name: Send Telegram Notification
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: -1001804111897
        TOPIC_ID: 21182
      run: |
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "reply_to_message_id=${TOPIC_ID}" \
          -d "parse_mode=Markdown"

    #Deploy to arvan k8s
    - name: Set up Kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.32.0'

    - name: Configure Kubernetes Context
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config

    - name: Rollout Restart Kubernetes Deployment
      run: kubectl rollout restart deployment/${{ steps.extract_repo_name.outputs.repo_name }}-${{ steps.extract_branch.outputs.branch }}

    - name: Remove Kubeconfig for Security
      run: rm -rf $HOME/.kube

    - name: Notify on Failure
      if: failure()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: -1001804111897
        TOPIC_ID: 21182
      run: |
        FAILURE_MSG="âŒ *CI/CD Pipeline Failed!* ğŸš¨%0A"
        FAILURE_MSG+="ğŸ“Œ *Repository:* [${{ github.repository }}](https://github.com/${{ github.repository }})%0A"
        FAILURE_MSG+="ğŸŒ¿ *Branch:* \`${{ steps.extract_branch.outputs.branch }}\`%0A"
        FAILURE_MSG+="ğŸ”— [ğŸ“œ See Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})%0A"
        FAILURE_MSG+="ğŸ‘¤ *Triggered by:* \`${{ github.actor }}\`"

        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${FAILURE_MSG}" \
          -d "reply_to_message_id=${TOPIC_ID}" \
          -d "parse_mode=Markdown"

    - name: Notify on Success
      if: success()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: -1001804111897
        TOPIC_ID: 21182
      run: |
        SUCCESS_MSG="âœ… *CI/CD Pipeline Success!* ğŸ‰%0A"
        SUCCESS_MSG+="ğŸ“Œ *Repository:* [${{ github.repository }}](https://github.com/${{ github.repository }})%0A"
        SUCCESS_MSG+="ğŸŒ¿ *Branch:* \`${{ steps.extract_branch.outputs.branch }}\`%0A"
        SUCCESS_MSG+="ğŸ”— [ğŸ“œ See Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})%0A"

        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${SUCCESS_MSG}" \
          -d "reply_to_message_id=${TOPIC_ID}" \
          -d "parse_mode=Markdown"